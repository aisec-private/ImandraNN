let () = System.use "mk_weight_funs.iml"
let () = System.use "matrix.iml"

let () =
    for i = 1i to 5i do
        for j = 1i to 9i do
            let file_path = "./acas_xu/networks_iml/ACASXU_run2a_" ^ (string_of_int i) ^ "_" ^ (string_of_int j) ^ "_batch_2000.iml" in
            let () = Printf.printf "opening %s\n" file_path in
            let () = System.use file_path in

            let out_path = "./acas_xu/networks_iml/acas_xu_sparse_" ^ (string_of_int i) ^ "_" ^ (string_of_int j) ^ ".iml" in
            let oc = open_out out_path in
            (* Printf.fprintf oc "module Weights = struct"; *)
            Printf.fprintf oc "let layer0_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 6 Weights.layer0));
            Printf.fprintf oc "let layer0 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 6\n\t\t| Value (i,j) -> Map.get (i,j) layer0_map\n\t)\n\n";
            Printf.fprintf oc "let layer1_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 51 Weights.layer1));
            Printf.fprintf oc "let layer1 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer1_map\n\t)\n\n";
            Printf.fprintf oc "let layer2_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 51 Weights.layer2));
            Printf.fprintf oc "let layer2 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer2_map\n\t)\n\n";
            Printf.fprintf oc "let layer3_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 51 Weights.layer3));
            Printf.fprintf oc "let layer3 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer3_map\n\t)\n\n";
            Printf.fprintf oc "let layer4_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 51 Weights.layer4));
            Printf.fprintf oc "let layer4 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer4_map\n\t)\n\n";
            Printf.fprintf oc "let layer5_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 50 51 Weights.layer5));
            Printf.fprintf oc "let layer5 = fc relu (\n\tfunction\n\t\t| Rows -> 50\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer5_map\n\t)\n\n";
            Printf.fprintf oc "let layer6_map =\n%s\n\n" @@ to_fun (Matrix.to_list (Matrix.of_list_list 5 51 Weights.layer6));
            Printf.fprintf oc "let layer6 = fc relu (\n\tfunction\n\t\t| Rows -> 5\n\t\t| Cols -> 51\n\t\t| Value (i,j) -> Map.get (i,j) layer6_map\n\t)\n\n";
            Printf.fprintf oc "end";
            (* close_out oc *)
        done
    done
    [@@program]